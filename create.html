<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/AMR2010M/butterfly-css@latest/attributes.css">
</head>
<body body>
    <div w-80p gray  rounded min-h-600 center p-50 nof m-50 flex-column>
<h1>publish your  post here!</h1>
<input type="text"placeholder='العنوان' id="title" tbold tmedium w-90p min-h-100 rounded blue-50 m-50>
<textarea type="text"placeholder='المحتوي' id="poem" w-90p min-h-300 rounded blue-50 m-50 tsmall tbold></textarea>
<input type="file"placeholder='choose img or file' id="myimg" tbold tmedium m-10 btn="blue" bp center >
<button type="submit" btn="blue" center id="submit">تاكيد النشر </button>
    </div>
</body>
<script type="module">
var submit=document.getElementById('submit');

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabaseUrl = 'https://skhatgfvgvyociqfamsp.supabase.co';
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNraGF0Z2Z2Z3Z5b2NpcWZhbXNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDY3MjMsImV4cCI6MjA3NTUyMjcyM30.m0L9G26jHf79KNL_YCDNJHS2hWYHuJ4WCzLAHKhj2XI";

    const supabase = createClient(supabaseUrl, supabaseKey);
    const {data:{user}}= await supabase.auth.getUser();
    if(user){
    console.log('hello'+user);
}
else{
    window.location.href="/signin";
}
submit.onclick= async function(){
     var poem=document.getElementById('poem').value;
var title=document.getElementById('title').value;
var myimg=document.getElementById('myimg');
 const file = myimg.files[0];



const API_KEY = "AIzaSyC1Dvh3GDuiwmryzwFTv-NpcYu9zDNinR8"; 
        
        async function generateContent() {
            
           var prompt=`(you are a  just a moderator )plss just respond with the word  'SAFE' without quotes with capital letters and witout explaining and  without any other letter  if its safe or explain why itsn't safe if its not safe here is the post:{'${poem}'}  plss respond according to the below rules:
    
    1:nothing haram at at all in islam
    2:no insults
    3:nothing  very spammy if its normal promotion allow it
    4:it must have value not just some letters
    5:its not waste of time 
    6:letters  are more than 10
7:if the user report a problem or error or something like that in safe way dont treat it as unsafe
8:just follow rules dont define safeness yourself
    `;
           const apiKey = "AIzaSyAVDSU27FDw2ir0e6STg3hbZUN98Zy3RVo"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
 const generationConfig = {
                
                temperature: 1.0, 
            };
            const chatHistory = [{ 
                role: "user", 
                parts: [{ text: prompt }] 
            }];

            const payload = { 
                contents: chatHistory 
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

             
                if (result.candidates && result.candidates.length > 0 && 
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                 if(text=='SAFE'){
   
 const {error:imgerror} = await supabase.storage.from('imgs').upload(`public/${file.name}`,file,{ cacheControl: '3600',  upsert: true, });
 if(imgerror){alert(imgerror)}

 else{const {data:{ publicUrl }} = supabase.storage.from('imgs').getPublicUrl(`public/${file.name}`);

    const {error}=  await supabase.from('poems').insert({
title: title, 
poem: poem,
 user_id: user.id,
img: publicUrl ,
 author:user.email

    });
    if(error){
        alert(error);

    }
    else{
        window.location.href="/community.html";
    }
}
}
else{alert(text)}
                    
                } else {
                    mytext.innerText = "فشل في الحصول على إجابة. يرجى المحاولة مرة أخرى.";
                    console.error("Unexpected API response structure:", result);
                }

            } catch (error) {
                console.error('Error:', error);
                mytext.innerText = `حدث خطأ: ${error.message}`;
            } finally {
               
            }
    


 }
generateContent();
    }
      document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
 
});
    let devtoolsOpen = false;

setInterval(() => {
    const widthThreshold = window.outerWidth - window.innerWidth > 100;
    const heightThreshold = window.outerHeight - window.innerHeight > 100;
    if (widthThreshold || heightThreshold) {
        if (!devtoolsOpen) {
            devtoolsOpen = true;
        }
    } else {
        devtoolsOpen = false;
    }
}, 1000);
document.addEventListener('keydown', function(e) {
    // Check if Ctrl (or Cmd) + U is pressed
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'u') {
        e.preventDefault();  // Stop the default action
       
    }
});
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
       
    }
});
</script>
</html>