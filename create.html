<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/AMR2010M/butterfly-css@latest/attributes.css">
</head>
<body body>
    <div w-80p gray  rounded min-h-600 center p-50 nof m-50 flex-column>
<h1>publish your  post here!</h1>
<input type="text"placeholder='العنوان' id="title" tbold tmedium w-90p min-h-100 rounded blue-50 m-50>
<textarea type="text"placeholder='المحتوي' id="poem" w-90p min-h-300 rounded blue-50 m-50 tsmall tbold></textarea>
<input type="file"placeholder='choose img or file' id="myimg" tbold tmedium m-10 btn="blue" bp center >
<button type="submit" btn="blue" center id="submit">تاكيد النشر </button>
    </div>
</body>
<script type="module">
var submit=document.getElementById('submit');

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabaseUrl = 'https://skhatgfvgvyociqfamsp.supabase.co';
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNraGF0Z2Z2Z3Z5b2NpcWZhbXNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDY3MjMsImV4cCI6MjA3NTUyMjcyM30.m0L9G26jHf79KNL_YCDNJHS2hWYHuJ4WCzLAHKhj2XI";

    const supabase = createClient(supabaseUrl, supabaseKey);
    const {data:{user}}= await supabase.auth.getUser();
    if(user){
    console.log('hello'+user);
}
else{
    window.location.href="/signin";
}
submit.onclick= async function(){
     var poem=document.getElementById('poem').value;
var title=document.getElementById('title').value;
var myimg=document.getElementById('myimg');
 const file = myimg.files[0];



const API_KEY = "AIzaSyC1Dvh3GDuiwmryzwFTv-NpcYu9zDNinR8"; 
        
        async function generateContent() {
            
           var prompt=`plss just say 'SAFE' without any other letter or explain why itsn't safe if its not safe here is the post:{'${poem}'}  plss respond according to the below rules:
    
    1:nothing haram at at all in islam
    2:no insults
    3:nothing  very spammy if its normal promotion allow it
    4:it must have value not just some letters
    5:its not waste of time 
    6:letters  are more than 10`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    // Check for non-200 status codes
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                
                // Extract the generated text
                const text = data.candidates[0].content.parts[0].text;
                return text;
                
            
            } catch (error) {
                console.error("Fetch error:", error);
                var xerror = `Error: ${error.message}`;
                alert(xerror);
            }
       const ISSAFE = await generateContent();
if(ISSAFE=='SAFE'){
   
 const {error:imgerror} = await supabase.storage.from('imgs').upload(`public/${file.name}`,file,{ cacheControl: '3600',  upsert: true, });
 if(imgerror){alert(imgerror)}

 else{const {data:{ publicUrl }} = supabase.storage.from('imgs').getPublicUrl(`public/${file.name}`);

    const {error}=  await supabase.from('poems').insert({
title: title, 
poem: poem,
 user_id: user.id,
img: publicUrl ,
 author:user.email

    });
    if(error){
        alert(error);

    }
    else{
        window.location.href="/community.html";
    }
}
}
else{alert(ISSAFE)}
 }

}
</script>
</html>